# Blog API Copilot Instructions

## Architecture Overview

This is a layered Express.js blog API with strict separation: **Routes → Middlewares → Controllers → Models → Database**. All layers use ES modules with path aliases (e.g., `#controllers/`, `#models/`).

## Key Patterns

### 1. Route Structure

Routes follow this exact pattern - always apply middlewares in this order:

```javascript
router.post(
  '/',
  onlyAdmin, // Authorization first (if needed)
  validate({ bodySchema: postSchema }), // Validation second
  Controller.action // Controller last
)
```

### 2. Controller Pattern

Controllers are simple async functions that:

- Extract data from `req.body`/`req.params`/`req.query`
- Call appropriate Model methods
- Return JSON responses with proper HTTP status codes
- Handle 404s explicitly: `if (!result) return res.status(404).json({ error: 'Not found' })`

### 3. Model Layer

Models encapsulate Prisma database operations:

- Import `{ db }` from `#config/database.js` (Prisma client)
- Use async/await with Prisma methods
- Return raw data (no HTTP concerns)
- Example: `await db.post.findMany({ where: { isDraft: false } })`

### 4. Validation with Zod

- Schemas in `lib/schemas/` define validation rules
- Use `validate()` middleware with `bodySchema`, `paramsSchema`, `querySchema`
- Common pattern: `z.coerce.number().positive().optional()` for query params

### 5. Authentication & Authorization

- `verifyToken` middleware adds `req.user` with `{ id, username, admin }`
- `onlyAdmin` is an array: `[verifyToken, adminCheck]`
- Admin-only routes: POST/PUT/DELETE operations, drafts access

## Development Workflow

### Database Operations

```bash
npx prisma migrate dev --name "description"  # Create & apply migration
npx prisma generate                          # Regenerate client after schema changes
npx prisma studio                           # GUI database browser
npx prisma db seed                          # Run seed script
```

### Development Commands

```bash
pnpm dev    # Auto-restart server with --watch
pnpm start  # Production mode
pnpm lint   # ESLint check
```

## Project-Specific Conventions

### Path Aliases (Critical)

Always use these imports - never relative paths:

- `#controllers/` → `./controllers/`
- `#models/` → `./models/`
- `#middlewares/` → `./middlewares/`
- `#lib/` → `./lib/`
- `#config/` → `./config/`
- `#routes/` → `./routes/`

### Error Handling

- Global error handler in `middlewares/handleError.js`
- Controllers return errors directly: `res.status(400).json({ error: 'Message' })`
- Validation errors handled by `validate()` middleware automatically

### Business Rules

- Posts have `isDraft` boolean - drafts only visible to admins
- Only admins can create/edit/delete posts and comments
- Regular users can only create comments
- All IDs are UUIDs generated by Prisma

## File Patterns

When adding new features:

1. **Schema**: Create Zod validation in `lib/schemas/`
2. **Model**: Add database operations in `models/`
3. **Controller**: Add business logic in `controllers/`
4. **Routes**: Wire up endpoints in `routes/` with proper middleware order
5. **Update app.js**: Add new router if needed

## Common Gotchas

- Middleware order matters: auth before validation, validation before controller
- Use `z.coerce.number()` for query parameters (they come as strings)
- Prisma returns `null` for not found, check explicitly in controllers
- Admin middleware is an array, not a single function
